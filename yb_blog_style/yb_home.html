<!DOCTYPE html>
<html>

<head>
<title>YB-Home</title>

<meta name="keywords" content="" />
<meta name="description" content="" />

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width" />

<!--[if lt IE 9]>
<script type="text/javascript" src="layout/plugins/html5.js"></script>
<![endif]-->

<link rel="stylesheet" href="layout/style.css" type="text/css" />
<script type="text/javascript" src="layout/js/jquery.js"></script>

<!-- PrettyPhoto start -->
<!-- <link rel="stylesheet" href="layout/plugins/prettyphoto/css/prettyPhoto.css" type="text/css" />
<script type="text/javascript" src="layout/plugins/prettyphoto/jquery.prettyPhoto.js"></script> -->
<link rel="stylesheet" href="prettyPhoto/css/prettyPhoto.css" type="text/css" />
<script type="text/javascript" src="prettyPhoto/js/jquery.prettyPhoto.js"></script>
<!-- <link rel="stylesheet" href="prettyPhoto/css/lrtk.css" type="text/css" />
<script type="text/javascript" src="prettyPhoto/js/lrtk.js"></script> -->
<!-- PrettyPhoto end -->

<!-- jQuery tools start -->
<script type="text/javascript" src="layout/plugins/tools/jquery.tools.min.js"></script>
<!-- jQuery tools end -->

<!-- Calendar start -->
<link rel="stylesheet" href="layout/plugins/calendar/calendar.css" type="text/css" />
<script type="text/javascript" src="layout/plugins/calendar/calendar.js"></script>
<!-- Calendar end -->

<!-- ScrollTo start -->
<script type="text/javascript" src="layout/plugins/scrollto/jquery.scroll.to.min.js"></script>
<!-- ScrollTo end -->

<!-- MediaElements start -->
<link rel="stylesheet" href="layout/plugins/video-audio/mediaelementplayer.css" />
<script src="layout/plugins/video-audio/mediaelement-and-player.js"></script>
<!-- MediaElements end -->

<!-- FlexSlider start -->
<link rel="stylesheet" href="layout/plugins/flexslider/flexslider.css" type="text/css" />
<script type="text/javascript" src="layout/plugins/flexslider/jquery.flexslider-min.js"></script>
<!-- FlexSlider end -->

<!-- iButtons start -->
<link rel="stylesheet" href="layout/plugins/ibuttons/css/jquery.ibutton.css" type="text/css" />
<script type="text/javascript" src="layout/plugins/ibuttons/lib/jquery.ibutton.min.js"></script>
<!-- iButtons end -->

<!-- jQuery Form Plugin start -->
<script type="text/javascript" src="layout/plugins/ajaxform/jquery.form.js"></script>
<!-- jQuery Form Plugin end -->

<script type="text/javascript" src="layout/js/main.js"></script>

<!-- FileSaver.js文件生成 -->
<script type="text/javascript" src="layout/plugins/file/FileSaver.js"></script>

<!-- doT模板引擎 -->
<script type="text/javascript" src="layout/plugins/doT/doT.min.js"></script>
<script type="text/x-dot-template" id="dot_content">
<div class="block_viewTimes">
    <p>主页访问次数: <span id="viewTimes">{{=it.viewTimes}}</span></p>
</div>
</script>


<script src="http://pv.sohu.com/cityjson?ie=utf-8"></script><!-- 获取ip信息 -->
<script type="text/javascript">  
    // 记录ip信息
    var ipAddress = returnCitySN;

    // 获取当前的日期时间 格式"yyyy-MM-dd HH:MM:SS"
    function dateFmt(date, fmt) {
        var o = {
            "M+" : date.getMonth()+1,                 //月份
            "d+" : date.getDate(),                    //日
            "H+" : date.getHours(),                   //小时
            "h+" : date.getHours(),                   //小时
            "m+" : date.getMinutes(),                 //分
            "s+" : date.getSeconds(),                 //秒
            "q+" : Math.floor((date.getMonth()+3)/3), //季度
            "S"  : date.getMilliseconds()             //毫秒
        };
        if(/(y+)/.test(fmt)) {
            fmt=fmt.replace(RegExp.$1, (date.getFullYear()+"").substr(4 - RegExp.$1.length));
        }
        for(var k in o) {
            if(new RegExp("("+ k +")").test(fmt)){
                fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));
            }
        }
        return fmt;
    };

    var date = dateFmt(new Date(), "yyyy-MM-dd hh:mm:ss");
</script>

<script type="text/javascript">
	jQuery(function () {
        $("a[rel^='prettyPhoto']").prettyPhoto();
        // $('.yb-header').load('yb_content_header.html');
        // $('.yb-header .section_main_menu .main_menu ul li').eq(3).addClass('current_page_item'); // js添加样式未成功
        $('.yb-right').load('yb_content_right.html');
        $('.yb-footer').load('yb_content_footer.html');
        init();
	});

    var viewTimes = 0;
    function init() {
        // 获取阅览次数并展示，更新+1
        readJson();
        // 增加写入到History记录
        // readJson2(); // 放到上一步执行完后再去执行，为了viewTimes
    }

    // 读取远端的json文件
    function readJson() {
        let url = "https://yuanbao-oss.oss-cn-shenzhen.aliyuncs.com/file/public/develop_resources/YB/Prod/HomeRecord.json";
        let params = {
            headers: {
                'Cache-Control': 'no-cache' // 不缓存
            }
        };
        fetch(url, params)
            .then((res) => res.text())
            .then((data) => {
                solveJsonHomeRecord(data); // 改写相关信息并上传
            })
            .catch((err) => console.log(err));
    }

    // 将HomeRecord的json文本更新上传
    function solveJsonHomeRecord(text) {
        var recordObj = eval('(' + text + ')');
        viewTimes = recordObj.viewTimes + 1;
        recordObj.viewTimes = viewTimes;
        recordObj.ipAddress = ipAddress;
        recordObj.date = date;
        showViewTimes(recordObj); // 页面展示出来

        // 上传
        setTimeout(function() {
                uploadToOss(JSON.stringify(recordObj));
            }, 200);

        // 增加写入到History记录
        readJson2();
    }

    // 上传至OSS服务器
    function uploadToOss(text) {
        // 添加文件
        let fileName = "HomeRecord.json";
        // 方式一
        // var blob = new Blob([text], {type: "text/plain;charset=utf-8"});
        // saveAs(blob, "文件导出测试.txt");

        // 方式二
        var file = new File([text], fileName, {type: "text/plain;charset=utf-8"});
        // saveAs(file); // 保存文件到本地
        
        uploader.addFile(file);
        set_upload_param(uploader, '', false);
    }

    // 渲染页面上展示的查看次数
    function showViewTimes(recordObj) {
        var tempHtml = doT.template($("#dot_content").text());
        var parseText = tempHtml(recordObj);
        $("#md_content").empty();
        $("#md_content").append(parseText);
    }

    // =============================================================================================================
    // 读取远端的json文件2-写入历史记录
    function readJson2() {
        let url = "https://yuanbao-oss.oss-cn-shenzhen.aliyuncs.com/file/public/develop_resources/YB/Prod/HomeRecordHistory.json";
        let params = {
            headers: {
                'Cache-Control': 'no-cache' // 不缓存
            }
        };
        fetch(url, params)
            .then((res) => res.text())
            .then((data) => {
                solveJsonHomeRecord2(data); // 改写相关信息并上传
            })
            .catch((err) => console.log(err));
    }

    // 将HomeRecord的json文本更新上传2
    function solveJsonHomeRecord2(text) {
        var history = eval('(' + text + ')');
        let recordObj = {};
        recordObj.viewTimes = viewTimes;
        recordObj.ipAddress = ipAddress;
        recordObj.date = date;
        history.push(recordObj);
  
        // 上传
        setTimeout(function() {
                uploadToOss2(JSON.stringify(history));
            }, 200);
    }

    // 上传至OSS服务器2
    function uploadToOss2(text) {
        // 添加文件
        let fileName = "HomeRecordHistory.json";
        // 方式一
        // var blob = new Blob([text], {type: "text/plain;charset=utf-8"});
        // saveAs(blob, "文件导出测试.txt");

        // 方式二
        var file = new File([text], fileName, {type: "text/plain;charset=utf-8"});
        // saveAs(file); // 保存文件到本地
        
        uploader.addFile(file);
        set_upload_param(uploader, '', false);
    }


</script>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /></head>

<body>
    <!-- 参考页面blog_post.html -->
	<div class="wrapper "> <!-- 去掉样式里的sticky_footer -->
    	
        <!-- HEADER BEGIN -->
        <header>
            <div id="header">
                <a href="https://github.com/yuanbao15">
                    <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 1;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub">
                </a>
                
                <section class="bottom">
                    <div class="inner">
                        <div id="logo_top"><a href="yb_home.html"><img src="images/logo_top3.png" alt="Welcome to yuanbao's helloworld!" title="Welcome to yuanbao's helloworld!" /></a></div>
                        
                        <div class="block_today_date">
                            <div class="num"><p id="num_top" /></div>
                            <div class="other">
                                <p class="month_year"><span id="month_top"></span>, <span id="year_top"></span></p>
                                <p id="day_top" class="day" />
                            </div>
                        </div>
                        
                        <div class="clearboth"></div>
                    </div>
                </section>
                
                <section class="section_main_menu">
                    <div class="inner">
                        <nav class="main_menu">
                            <ul>
                                <li class="current_page_item"><a href="yb_home.html">Home</a>\</li>
                                <li><a href="yb_resume_2.html">Resumes</a>
                                    <ul>
                                        <li><a href="yb_resume_2.html">个人简历2-PDF</a></li>
                                        <li><a href="yb_resume_1.html">个人简历1</a></li>
                                    </ul>
                                </li>
                                <li><a href="yb_show_photos.html">Show</a>
                                    <ul>
                                        <li><a href="yb_show_photos.html">图片集</a></li>
                                        <li><a href="yb_show_videos.html">视频集</a></li>
                                        <li><a href="yb_show_notes.html">笔记集</a></li>
                                    </ul>
                                </li>
                                <li><a href="yb_others_1.html">Others</a>
                                    <ul>
                                        <li><a href="yb_others_1.html">About Me</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </section>
                
                <section class="section_secondary_menu">
                    <div class="inner">
                        <nav class="secondary_menu">
                            <ul>
                                <li><a >Check it out!</a></li>
                            </ul>
                        </nav>
                        
                        
                        <div class="block_clock">
                            <p>Time: <span id="time"></span></p>
                        </div>


                        <div id="md_content">
                            <!-- 使用dot模板引擎填充此部分内容 -->
                            <div class="block_viewTimes">
                                <p>主页访问次数: <span id="viewTimes">1</span></p>
                            </div>
                        </div>
                        

                    </div>
                </section>
            </div>
        </header>
        <!-- HEADER END -->
        
        <!-- CONTENT BEGIN -->
        <div id="content" class="right_sidebar">
        	<div class="inner">
            	<div class="general_content">
                	<div class="main_content">
                        
                        <article class="block_single_post">
                        	<div class="f_pic"><a href="#"><img src="images/pic_blog_post_1.jpg" alt="" /></a></div>
                          <p class="title"><a href="#">Words which don't look even slightly.</a></p>
                            <p class="subtitle">Many variations of passages of available, but the majority have suffered alteration in some form. Humour, or randomised words which don't look even slightly believable.</p>
                            
                            <div class="info">
                                <div class="date"><p>15 July, 2012</p></div>
                                <div class="author"><p>By: <a href="#">John Doe</a></p></div>
                                    
                            	<div class="r_part">
                                	<div class="category"><p>category: <a href="#">BUSINESS</a></p></div>
                                    <a href="#" class="views">650</a>
                                    <a href="#" class="comments">25</a>
                                </div>
                            </div>
                            
                            <div class="content">
                            	
                            </div>
                            
                            <div class="line_3" style="margin:4px 0px 23px;"></div>
                        	
                            <div class="about_author">
                                <h4>About the Author</h4>
                                
                                <div class="photo"><a href="yb_others_1.html"><img src="../Pic/Jordan.jpg" width="70px" alt="" /></a></div>
                                <div class="bio">
                                    <p class="name"><a href="yb_others_1.html">Yuanbao15</a></p>
                                    <p>本名章光旭，网名：元宝/yuanbao/yuanbao15.</br>
                                    90后程序猿一枚，个人邮箱：<a href="mailto:yuanbao15@163.com?Subject=Hello&Body=你好，打个招呼！">yuanbao15@163.com</a></br>
                                    Github地址：<a href="https://github.com/yuanbao15">https://github.com/yuanbao15</a>
                                    </p>
                                </div>
                                
                                <div class="clearboth"></div>
                            </div>
                            
                            <div class="line_3" style="margin:17px 0px 5px;"></div>
                        </article>
                        
                        
                        <div class="separator" style="height:10px;"></div>
                        
                    </div>
                    
                    <!-- 右边栏 start -->
                    <div class="yb-right"></div>
                    <!-- 右边栏 end -->
                    
                	<div class="clearboth"></div>
                </div>
            </div>
        </div>
    	<!-- CONTENT END -->
        
        <!-- FOOTER BEGIN -->
        <div class="yb-footer"></div>
        <!-- FOOTER END -->
    </div>
    
    <!-- plupload组件，隐藏 -->
    <div style="display: none;">
        <h4>您所选择的文件列表：</h4>
        <div id="ossfile">你的浏览器不支持flash,Silverlight或者HTML5！</div>

        <br/>

        <div id="container">
            <a id="selectfiles" href="javascript:void(0);" class='btn'>选择文件</a>
            <a id="postfiles" href="javascript:void(0);" class='btn'>开始上传</a>
        </div>

        <pre id="console"></pre>
    </div>
</body>

<!-- OSS对象存储 -->
<script type="text/javascript" src="ossUpload/lib/crypto1/crypto/crypto.js"></script>
<script type="text/javascript" src="ossUpload/lib/crypto1/hmac/hmac.js"></script>
<script type="text/javascript" src="ossUpload/lib/crypto1/sha1/sha1.js"></script>
<script type="text/javascript" src="ossUpload/lib/base64.js"></script>
<script type="text/javascript" src="ossUpload/lib/plupload-2.1.2/js/plupload.full.min.js"></script>
<script type="text/javascript" src="ossUpload/upload.js"></script>

</html>